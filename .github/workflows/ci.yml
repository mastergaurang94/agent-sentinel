name: ci

on:
  push:
    branches: [main]
  pull_request:

env:
  GO_VERSION: "1.24"
  MODEL_URL: https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/onnx/model.onnx
  MODEL_SHA256: 6fd5d72fe4589f189f8ebc006442dbb529bb7ce38f8082112682524616046452
  VOCAB_URL: https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/vocab.txt

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Check gofmt
        run: |
          fmt_out=$(gofmt -l .)
          if [ -n "$fmt_out" ]; then
            echo "Files not formatted:"
            echo "$fmt_out"
            exit 1
          fi

      - name: Go vet
        run: go vet ./...

      - name: Go test
        run: go test ./...

      - name: Go test (race, proxy packages)
        run: go test -race ./internal/... ./ratelimit/...

      - name: govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  docker-build:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build proxy image
        run: docker build -t agent-sentinel:ci .

      - name: Build embedding sidecar image
        run: |
          docker build \
            --build-arg MODEL_URL=${MODEL_URL} \
            --build-arg MODEL_SHA256=${MODEL_SHA256} \
            embedding-sidecar \
            -t embedding-sidecar:ci

