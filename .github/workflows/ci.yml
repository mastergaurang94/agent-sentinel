name: ci

on:
  push:
    branches: [main]
  pull_request:

env:
  GO_VERSION: "1.24"
  MODEL_URL: https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/onnx/model.onnx
  MODEL_SHA256: 6fd5d72fe4589f189f8ebc006442dbb529bb7ce38f8082112682524616046452
  VOCAB_URL: https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/vocab.txt

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    services:
      redis-stack:
        image: redis/redis-stack:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check gofmt
        run: |
          fmt_out=$(gofmt -l .)
          if [ -n "$fmt_out" ]; then
            echo "Files not formatted:"
            echo "$fmt_out"
            exit 1
          fi

      - name: Go vet
        run: go vet ./...

      - name: Prepare sidecar socket dir
        run: mkdir -p .sockets

      - name: Build embedding sidecar image
        run: |
          docker build \
            --build-arg MODEL_URL=${MODEL_URL} \
            --build-arg MODEL_SHA256=${MODEL_SHA256} \
            --build-arg VOCAB_URL=${VOCAB_URL} \
            embedding-sidecar \
            -t embedding-sidecar:ci

      - name: Start embedding sidecar (UDS)
        run: |
          docker run -d --name embedding-sidecar \
            --network host \
            -v "${GITHUB_WORKSPACE}/.sockets:/sockets" \
            -e REDIS_URL=redis://localhost:6379 \
            -e LOOP_EMBEDDING_SIDECAR_UDS=/sockets/embedding-sidecar.sock \
            embedding-sidecar:ci

      - name: Wait for sidecar socket
        run: |
          for i in {1..50}; do
            if [ -S .sockets/embedding-sidecar.sock ]; then
              exit 0
            fi
            sleep 0.2
          done
          echo "Sidecar socket not ready" >&2
          ls -la .sockets || true
          exit 1

      - name: Go test
        env:
          REDIS_URL_INTEGRATION: redis://localhost:6379
          RUN_FULLSTACK_SIDECAR: "1"
          LOOP_EMBEDDING_SIDECAR_UDS: ${{ github.workspace }}/.sockets/embedding-sidecar.sock
        run: go test ./...

      - name: Go test (race, proxy packages)
        env:
          REDIS_URL_INTEGRATION: redis://localhost:6379
        run: go test -race ./internal/...

      - name: Stop embedding sidecar
        if: always()
        run: docker rm -f embedding-sidecar

  docker-build:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build proxy image
        run: docker build -t agent-sentinel:ci .

      - name: Build embedding sidecar image
        run: |
          docker build \
            --build-arg MODEL_URL=${MODEL_URL} \
            --build-arg MODEL_SHA256=${MODEL_SHA256} \
            embedding-sidecar \
            -t embedding-sidecar:ci

